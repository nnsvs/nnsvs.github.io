<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nnsvs.train_util &mdash; nnsvs 0.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=01f34227"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            nnsvs
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Demos</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Demos.html">NNSVS demos</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recipes.html">Getting started with recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_choose_model.html">How to choose model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../custom_models.html">Defining your custom model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devdocs.html">Development guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips.html">Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../update_guide.html">Update guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../optuna.html">Hyperparameter optimization with Optuna</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../train_vocoders.html">How to train neural vocoders with ParallelWaveGAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../train_usfgan.html">How to train uSFGAN/SiFiGAN vocoders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../enunu2nnsvs.html">How to convert ENUNU models to NNSVS’ ones</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview of NNSVS’s SVS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Package reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/base.html">nnsvs.base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/model.html">nnsvs.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/acoustic_models.html">nnsvs.acoustic_models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/postfilters.html">nnsvs.postfilters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/discriminators.html">nnsvs.discriminators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/pretrained.html">nnsvs.pretrained</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/svs.html">nnsvs.svs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/dsp.html">nnsvs.dsp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/gen.html">nnsvs.gen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/io.html">nnsvs.io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/mdn.html">nnsvs.mdn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/pitch.html">nnsvs.pitch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/multistream.html">nnsvs.multistream</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/util.html">nnsvs.util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/train_util.html">nnsvs.train_util</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../links.html">Useful links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../papers.html">Papers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Meta information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Change log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">nnsvs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">nnsvs.train_util</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for nnsvs.train_util</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">hydra</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">librosa</span>
<span class="kn">import</span> <span class="nn">librosa.display</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pysptk</span>
<span class="kn">import</span> <span class="nn">pyworld</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.distributed</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">hydra.utils</span> <span class="kn">import</span> <span class="n">get_original_cwd</span><span class="p">,</span> <span class="n">to_absolute_path</span>
<span class="kn">from</span> <span class="nn">nnmnkwii</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">nnsvs.base</span> <span class="kn">import</span> <span class="n">PredictionType</span>
<span class="kn">from</span> <span class="nn">nnsvs.gen</span> <span class="kn">import</span> <span class="n">gen_world_params</span>
<span class="kn">from</span> <span class="nn">nnsvs.logger</span> <span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span> <span class="nn">nnsvs.mdn</span> <span class="kn">import</span> <span class="n">mdn_get_most_probable_sigma_and_mu</span>
<span class="kn">from</span> <span class="nn">nnsvs.multistream</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_static_features</span><span class="p">,</span>
    <span class="n">get_static_stream_sizes</span><span class="p">,</span>
    <span class="n">get_windows</span><span class="p">,</span>
    <span class="n">multi_stream_mlpg</span><span class="p">,</span>
    <span class="n">select_streams</span><span class="p">,</span>
    <span class="n">split_streams</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">nnsvs.pitch</span> <span class="kn">import</span> <span class="n">lowpass_filter</span><span class="p">,</span> <span class="n">note_segments</span>
<span class="kn">from</span> <span class="nn">nnsvs.util</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">init_seed</span><span class="p">,</span> <span class="n">pad_2d</span>
<span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">DictConfig</span><span class="p">,</span> <span class="n">ListConfig</span><span class="p">,</span> <span class="n">OmegaConf</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span> <span class="k">as</span> <span class="n">SKMinMaxScaler</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">torch.cuda.amp</span> <span class="kn">import</span> <span class="n">GradScaler</span>
<span class="kn">from</span> <span class="nn">torch.nn.parallel</span> <span class="kn">import</span> <span class="n">DistributedDataParallel</span> <span class="k">as</span> <span class="n">DDP</span>
<span class="kn">from</span> <span class="nn">torch.utils</span> <span class="kn">import</span> <span class="n">data</span> <span class="k">as</span> <span class="n">data_utils</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.sampler</span> <span class="kn">import</span> <span class="n">BatchSampler</span>
<span class="kn">from</span> <span class="nn">torch.utils.tensorboard</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;seaborn-whitegrid&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ShuffleBatchSampler</span><span class="p">(</span><span class="n">BatchSampler</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batches</span><span class="p">,</span>
        <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_last</span> <span class="o">=</span> <span class="n">drop_last</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">log_params_from_omegaconf_dict</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_explore_recursive</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_explore_recursive</span><span class="p">(</span><span class="n">parent_name</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">DictConfig</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">DictConfig</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ListConfig</span><span class="p">):</span>
                <span class="n">_explore_recursive</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ListConfig</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>


<div class="viewcode-block" id="num_trainable_params">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.num_trainable_params.html#nnsvs.train_util.num_trainable_params">[docs]</a>
<span class="k">def</span> <span class="nf">num_trainable_params</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count the number of trainable parameters in the model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): Model to count the number of trainable parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Number of trainable parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">])</span></div>



<span class="k">def</span> <span class="nf">get_filtered_files</span><span class="p">(</span>
    <span class="n">data_root</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">,</span>
    <span class="n">filter_long_segments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">filter_num_frames</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
    <span class="n">filter_min_num_frames</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span> <span class="s2">&quot;*-feats.npy&quot;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">filter_long_segments</span><span class="p">:</span>
        <span class="n">valid_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">num_filtered</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">filter_num_frames</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">filter_min_num_frames</span><span class="p">:</span>
                <span class="n">valid_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is too long or short: </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">num_filtered</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">num_filtered</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered </span><span class="si">{</span><span class="n">num_filtered</span><span class="si">}</span><span class="s2"> files&quot;</span><span class="p">)</span>

        <span class="c1"># Print stats of lengths</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[before] Size of dataset: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[before] maximum length: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[before] minimum length: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[before] mean length: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[before] std length: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[before] median length: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">valid_files</span>

        <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[after] Size of dataset: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[after] maximum length: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[after] minimum length: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[after] mean length: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[after] std length: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[after] median length: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">files</span><span class="p">,</span> <span class="n">lengths</span>


<span class="k">def</span> <span class="nf">_is_batch_full</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">num_tokens</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">,</span> <span class="n">max_sentences</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_sentences</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">num_tokens</span> <span class="o">&gt;</span> <span class="n">max_tokens</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="mi">0</span>


<div class="viewcode-block" id="batch_by_size">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.batch_by_size.html#nnsvs.train_util.batch_by_size">[docs]</a>
<span class="k">def</span> <span class="nf">batch_by_size</span><span class="p">(</span>
    <span class="n">indices</span><span class="p">,</span>
    <span class="n">num_tokens_fn</span><span class="p">,</span>
    <span class="n">max_tokens</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_sentences</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">required_batch_size_multiple</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield mini-batches of indices bucketed by size. Batches may contain</span>
<span class="sd">    sequences of different lengths.</span>

<span class="sd">    Args:</span>
<span class="sd">        indices (List[int]): ordered list of dataset indices</span>
<span class="sd">        num_tokens_fn (callable): function that returns the number of tokens at</span>
<span class="sd">            a given index</span>
<span class="sd">        max_tokens (int, optional): max number of tokens in each batch</span>
<span class="sd">            (default: None).</span>
<span class="sd">        max_sentences (int, optional): max number of sentences in each</span>
<span class="sd">            batch (default: None).</span>
<span class="sd">        required_batch_size_multiple (int, optional): require batch size to</span>
<span class="sd">            be a multiple of N (default: 1).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_tokens</span> <span class="o">=</span> <span class="n">max_tokens</span> <span class="k">if</span> <span class="n">max_tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>
    <span class="n">max_sentences</span> <span class="o">=</span> <span class="n">max_sentences</span> <span class="k">if</span> <span class="n">max_sentences</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>
    <span class="n">bsz_mult</span> <span class="o">=</span> <span class="n">required_batch_size_multiple</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">count</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sample_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sample_lens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">num_tokens</span> <span class="o">=</span> <span class="n">num_tokens_fn</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">sample_lens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_tokens</span><span class="p">)</span>
        <span class="n">sample_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sample_len</span><span class="p">,</span> <span class="n">num_tokens</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">sample_len</span> <span class="o">&lt;=</span> <span class="n">max_tokens</span>
        <span class="p">),</span> <span class="s2">&quot;sentence at index </span><span class="si">{}</span><span class="s2"> of size </span><span class="si">{}</span><span class="s2"> exceeds max_tokens &quot;</span> <span class="s2">&quot;limit of </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">idx</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">,</span> <span class="n">max_tokens</span>
        <span class="p">)</span>
        <span class="n">num_tokens</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_len</span>

        <span class="k">if</span> <span class="n">_is_batch_full</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">num_tokens</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">,</span> <span class="n">max_sentences</span><span class="p">):</span>
            <span class="n">mod_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">bsz_mult</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">//</span> <span class="n">bsz_mult</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">%</span> <span class="n">bsz_mult</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">[:</span><span class="n">mod_len</span><span class="p">])</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">mod_len</span><span class="p">:]</span>
            <span class="n">sample_lens</span> <span class="o">=</span> <span class="n">sample_lens</span><span class="p">[</span><span class="n">mod_len</span><span class="p">:]</span>
            <span class="n">sample_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sample_lens</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_lens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">batches</span></div>



<span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">data_utils</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataset for numpy files</span>

<span class="sd">    Args:</span>
<span class="sd">        in_paths (list): List of paths to input files</span>
<span class="sd">        out_paths (list): List of paths to output files</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_paths</span><span class="p">,</span> <span class="n">out_paths</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_paths</span> <span class="o">=</span> <span class="n">in_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_paths</span> <span class="o">=</span> <span class="n">out_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="n">lengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_by_len</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_cache</span> <span class="o">=</span> <span class="n">allow_cache</span>
        <span class="k">if</span> <span class="n">allow_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caches</span> <span class="o">+=</span> <span class="p">[()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_paths</span><span class="p">))]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a pair of input and target</span>

<span class="sd">        Args:</span>
<span class="sd">            idx (int): index of the pair</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: input and target in numpy format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_cache</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caches</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">num_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">ordered_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an ordered list of indices. Batches will be constructed based</span>
<span class="sd">        on this order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_by_len</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">)[</span><span class="n">indices</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">indices</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the size of the dataset</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: size of the dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_paths</span><span class="p">)</span>


<div class="viewcode-block" id="ensure_divisible_by">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.ensure_divisible_by.html#nnsvs.train_util.ensure_divisible_by">[docs]</a>
<span class="k">def</span> <span class="nf">ensure_divisible_by</span><span class="p">(</span><span class="n">feats</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure that the number of frames is divisible by N.</span>

<span class="sd">    Args:</span>
<span class="sd">        feats (np.ndarray): Input features.</span>
<span class="sd">        N (int): Target number of frames.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Input features with number of frames divisible by N.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">feats</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span>
    <span class="k">if</span> <span class="n">mod</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">feats</span> <span class="o">=</span> <span class="n">feats</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span> <span class="o">-</span> <span class="n">mod</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">feats</span></div>



<div class="viewcode-block" id="collate_fn_default">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.collate_fn_default.html#nnsvs.train_util.collate_fn_default">[docs]</a>
<span class="k">def</span> <span class="nf">collate_fn_default</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">reduction_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stream_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">streams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create batch</span>

<span class="sd">    Args:</span>
<span class="sd">        batch(tuple): List of tuples</span>
<span class="sd">            - x[0] (ndarray,int) : list of (T, D_in)</span>
<span class="sd">            - x[1] (ndarray,int) : list of (T, D_out)</span>
<span class="sd">        reduction_factor (int): Reduction factor.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Tuple of batch</span>
<span class="sd">            - x (FloatTensor) : Network inputs (B, max(T), D_in)</span>
<span class="sd">            - y (FloatTensor)  : Network targets (B, max(T), D_out)</span>
<span class="sd">            - lengths (LongTensor): Input lengths</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ensure_divisible_by</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reduction_factor</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
    <span class="n">x_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
                <span class="n">pad_2d</span><span class="p">(</span><span class="n">ensure_divisible_by</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reduction_factor</span><span class="p">),</span> <span class="n">max_len</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">stream_sizes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">streams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">y_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
                    <span class="n">pad_2d</span><span class="p">(</span>
                        <span class="n">ensure_divisible_by</span><span class="p">(</span>
                            <span class="n">select_streams</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stream_sizes</span><span class="p">,</span> <span class="n">streams</span><span class="p">),</span>
                            <span class="n">reduction_factor</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">max_len</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
                    <span class="n">pad_2d</span><span class="p">(</span><span class="n">ensure_divisible_by</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reduction_factor</span><span class="p">),</span> <span class="n">max_len</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="n">l_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">l_batch</span></div>



<div class="viewcode-block" id="collate_fn_random_segments">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.collate_fn_random_segments.html#nnsvs.train_util.collate_fn_random_segments">[docs]</a>
<span class="k">def</span> <span class="nf">collate_fn_random_segments</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">max_time_frames</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collate function with random segments</span>

<span class="sd">    Use segmented frames instead of padded entire frames. No padding is performed.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        max_time_frames must be larger than the shortest sequence in the training data.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (tuple): tupls of lit</span>
<span class="sd">            - x[0] (ndarray,int) : list of (T, D_in)</span>
<span class="sd">            - x[1] (ndarray,int) : list of (T, D_out)</span>
<span class="sd">        max_time_frames (int, optional): Number of time frames. Defaults to 256.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Tuple of batch</span>
<span class="sd">            - x (FloatTensor) : Network inputs (B, max(T), D_in)</span>
<span class="sd">            - y (FloatTensor)  : Network targets (B, max(T), D_out)</span>
<span class="sd">            - lengths (LongTensor): Input lengths</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">],</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>

    <span class="n">start_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xl</span> <span class="o">-</span> <span class="n">max_time_frames</span><span class="p">)</span> <span class="k">for</span> <span class="n">xl</span> <span class="ow">in</span> <span class="n">lengths</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="n">start_frames</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="n">starts</span> <span class="o">+</span> <span class="n">max_time_frames</span>
    <span class="n">x_cut</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">)]</span>
    <span class="n">y_cut</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">])</span> <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">)]</span>

    <span class="n">x_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x_cut</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">y_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">y_cut</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="c1"># NOTE: we don&#39;t actually need lengths since we don&#39;t perform padding</span>
    <span class="c1"># but just for consistency with collate_fn_default</span>
    <span class="n">l_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">max_time_frames</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">l_batch</span></div>



<div class="viewcode-block" id="get_data_loaders">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.get_data_loaders.html#nnsvs.train_util.get_data_loaders">[docs]</a>
<span class="k">def</span> <span class="nf">get_data_loaders</span><span class="p">(</span><span class="n">data_config</span><span class="p">,</span> <span class="n">collate_fn</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get data loaders for training and validation.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_config (dict): Data configuration.</span>
<span class="sd">        collate_fn (callable): Collate function.</span>
<span class="sd">        logger (logging.Logger): Logger.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Data loaders.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;filter_long_segments&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_config</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;filter_long_segments is not found in the data config. Consider set it explicitly.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disable filtering for long segments.&quot;</span><span class="p">)</span>
        <span class="n">filter_long_segments</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filter_long_segments</span> <span class="o">=</span> <span class="n">data_config</span><span class="o">.</span><span class="n">filter_long_segments</span>

    <span class="k">if</span> <span class="s2">&quot;filter_num_frames&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_config</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;filter_num_frames is not found in the data config. Consider set it explicitly.&quot;</span>
        <span class="p">)</span>
        <span class="n">filter_num_frames</span> <span class="o">=</span> <span class="mi">6000</span>
        <span class="n">filter_min_num_frames</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filter_num_frames</span> <span class="o">=</span> <span class="n">data_config</span><span class="o">.</span><span class="n">filter_num_frames</span>
        <span class="n">filter_min_num_frames</span> <span class="o">=</span> <span class="n">data_config</span><span class="o">.</span><span class="n">filter_min_num_frames</span>

    <span class="n">data_loaders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">samplers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train_no_dev&quot;</span><span class="p">,</span> <span class="s2">&quot;dev&quot;</span><span class="p">]:</span>
        <span class="n">in_dir</span> <span class="o">=</span> <span class="n">to_absolute_path</span><span class="p">(</span><span class="n">data_config</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span><span class="o">.</span><span class="n">in_dir</span><span class="p">)</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">to_absolute_path</span><span class="p">(</span><span class="n">data_config</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span><span class="o">.</span><span class="n">out_dir</span><span class="p">)</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

        <span class="n">in_files</span><span class="p">,</span> <span class="n">lengths</span> <span class="o">=</span> <span class="n">get_filtered_files</span><span class="p">(</span>
            <span class="n">in_dir</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">filter_long_segments</span><span class="o">=</span><span class="n">filter_long_segments</span><span class="p">,</span>
            <span class="n">filter_num_frames</span><span class="o">=</span><span class="n">filter_num_frames</span><span class="p">,</span>
            <span class="n">filter_min_num_frames</span><span class="o">=</span><span class="n">filter_min_num_frames</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">out_files</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_filtered_files</span><span class="p">(</span>
            <span class="n">out_dir</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">filter_long_segments</span><span class="o">=</span><span class="n">filter_long_segments</span><span class="p">,</span>
            <span class="n">filter_num_frames</span><span class="o">=</span><span class="n">filter_num_frames</span><span class="p">,</span>
            <span class="n">filter_min_num_frames</span><span class="o">=</span><span class="n">filter_min_num_frames</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Dynamic batch size</span>
        <span class="k">if</span> <span class="n">data_config</span><span class="o">.</span><span class="n">batch_max_frames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Dynamic batch size with batch_max_frames=</span><span class="si">{</span><span class="n">data_config</span><span class="o">.</span><span class="n">batch_max_frames</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                <span class="n">in_files</span><span class="p">,</span>
                <span class="n">out_files</span><span class="p">,</span>
                <span class="n">lengths</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
                <span class="n">allow_cache</span><span class="o">=</span><span class="n">data_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allow_cache&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                <span class="n">required_batch_size_multiple</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">required_batch_size_multiple</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ordered_indices</span><span class="p">()</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="n">batch_by_size</span><span class="p">(</span>
                <span class="n">indices</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">num_tokens</span><span class="p">,</span>
                <span class="n">max_tokens</span><span class="o">=</span><span class="n">data_config</span><span class="o">.</span><span class="n">batch_max_frames</span><span class="p">,</span>
                <span class="n">required_batch_size_multiple</span><span class="o">=</span><span class="n">required_batch_size_multiple</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Split mini-batches for each rank manually</span>
            <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                <span class="n">num_replicas</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">()</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Splitting mini-batches for rank </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">rank</span><span class="p">::</span><span class="n">num_replicas</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batches</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">num_replicas</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num mini-batches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_tokens</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch-size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="si">}</span><span class="s2">, Lens: </span><span class="si">{</span><span class="n">sizes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average batch size: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">batches</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">data_loader_extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;batch_sampler&quot;</span><span class="p">:</span> <span class="n">ShuffleBatchSampler</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="n">batches</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fixed batch size: </span><span class="si">{</span><span class="n">data_config</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">in_files</span><span class="p">,</span> <span class="n">out_files</span><span class="p">,</span> <span class="n">lengths</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                <span class="n">sampler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">DistributedSampler</span><span class="p">(</span>
                    <span class="n">dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">train</span>
                <span class="p">)</span>
                <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sampler</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">shuffle</span> <span class="o">=</span> <span class="n">train</span>
            <span class="n">data_loader_extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">data_config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="s2">&quot;sampler&quot;</span><span class="p">:</span> <span class="n">sampler</span><span class="p">,</span>
                <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span> <span class="n">shuffle</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">data_loaders</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_utils</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
            <span class="n">pin_memory</span><span class="o">=</span><span class="n">data_config</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">data_config</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="o">**</span><span class="n">data_loader_extra_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">samplers</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampler</span>

    <span class="k">return</span> <span class="n">data_loaders</span><span class="p">,</span> <span class="n">samplers</span></div>



<span class="k">def</span> <span class="nf">set_epochs_based_on_max_steps_</span><span class="p">(</span><span class="n">train_config</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set epochs based on max steps.</span>

<span class="sd">    Args:</span>
<span class="sd">        train_config (TrainConfig): Train config.</span>
<span class="sd">        steps_per_epoch (int): Number of steps per epoch.</span>
<span class="sd">        logger (logging.Logger): Logger.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;max_train_steps&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">train_config</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;max_train_steps is not found in the train config.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of iterations per epoch: </span><span class="si">{</span><span class="n">steps_per_epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">train_config</span><span class="o">.</span><span class="n">max_train_steps</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Set max_train_steps based on nepochs</span>
        <span class="n">max_train_steps</span> <span class="o">=</span> <span class="n">train_config</span><span class="o">.</span><span class="n">nepochs</span> <span class="o">*</span> <span class="n">steps_per_epoch</span>
        <span class="n">train_config</span><span class="o">.</span><span class="n">max_train_steps</span> <span class="o">=</span> <span class="n">max_train_steps</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Number of max_train_steps is set based on nepochs: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">max_train_steps</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Set nepochs based on max_train_steps</span>
        <span class="n">max_train_steps</span> <span class="o">=</span> <span class="n">train_config</span><span class="o">.</span><span class="n">max_train_steps</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">max_train_steps</span> <span class="o">/</span> <span class="n">steps_per_epoch</span><span class="p">))</span>
        <span class="n">train_config</span><span class="o">.</span><span class="n">nepochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Number of epochs is set based on max_train_steps: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of epochs: </span><span class="si">{</span><span class="n">train_config</span><span class="o">.</span><span class="n">nepochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of iterations: </span><span class="si">{</span><span class="n">train_config</span><span class="o">.</span><span class="n">max_train_steps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="save_checkpoint">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.save_checkpoint.html#nnsvs.train_util.save_checkpoint">[docs]</a>
<span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span>
    <span class="n">logger</span><span class="p">,</span>
    <span class="n">out_dir</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="p">,</span>
    <span class="n">lr_scheduler</span><span class="p">,</span>
    <span class="n">epoch</span><span class="p">,</span>
    <span class="n">is_best</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">postfix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a checkpoint.</span>

<span class="sd">    Args:</span>
<span class="sd">        logger (logging.Logger): Logger.</span>
<span class="sd">        out_dir (str): Output directory.</span>
<span class="sd">        model (nn.Module): Model.</span>
<span class="sd">        optimizer (Optimizer): Optimizer.</span>
<span class="sd">        lr_scheduler (LRScheduler): Learning rate scheduler.</span>
<span class="sd">        epoch (int): Current epoch.</span>
<span class="sd">        is_best (bool, optional): Whether or not the current model is the best.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        postfix (str, optional): Postfix. Defaults to &quot;&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">DDP</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span>

    <span class="n">out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_best</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;best_loss</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">.pth&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="s2">&quot;epoch</span><span class="si">{:04d}{}</span><span class="s2">.pth&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">postfix</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;state_dict&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;optimizer_state&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;lr_scheduler_state&quot;</span><span class="p">:</span> <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="p">},</span>
        <span class="n">path</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved checkpoint at </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_best</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;latest</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">get_stream_weight</span><span class="p">(</span><span class="n">stream_weights</span><span class="p">,</span> <span class="n">stream_sizes</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">stream_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_weights</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_sizes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">stream_weights</span><span class="p">)</span>

    <span class="n">S</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">stream_sizes</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">stream_sizes</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="n">S</span>
    <span class="k">return</span> <span class="n">w</span>


<span class="k">def</span> <span class="nf">_instantiate_optim</span><span class="p">(</span><span class="n">optim_config</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="c1"># Optimizer</span>
    <span class="n">optimizer_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">optim</span><span class="p">,</span> <span class="n">optim_config</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer_class</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="o">**</span><span class="n">optim_config</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Scheduler</span>
    <span class="n">lr_scheduler_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="p">,</span> <span class="n">optim_config</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">lr_scheduler_class</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="o">**</span><span class="n">optim_config</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_scheduler</span>


<span class="k">def</span> <span class="nf">_resume</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">resume_config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">resume_config</span><span class="o">.</span><span class="n">checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">resume_config</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load weights from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">resume_config</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">)</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">to_absolute_path</span><span class="p">(</span><span class="n">resume_config</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">))</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">]</span>
        <span class="n">model_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="n">valid_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">model_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">non_valid_state_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_state_dict</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_valid_state_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">non_valid_state_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skip loading </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> from checkpoint&quot;</span><span class="p">)</span>
        <span class="n">model_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">valid_state_dict</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resume_config</span><span class="o">.</span><span class="n">load_optimizer</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load optimizer state&quot;</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;optimizer_state&quot;</span><span class="p">])</span>
            <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;lr_scheduler_state&quot;</span><span class="p">])</span>


<div class="viewcode-block" id="setup">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.setup.html#nnsvs.train_util.setup">[docs]</a>
<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn_default</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setup for training</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict): configuration for training</span>
<span class="sd">        device (torch.device): device to use for training</span>
<span class="sd">        collate_fn (callable, optional): collate function. Defaults to collate_fn_default.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple): tuple containing model, optimizer, learning rate scheduler,</span>
<span class="sd">            data loaders, tensorboard writer, logger, and scalers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">getLogger</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyTorch version: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="kn">from</span> <span class="nn">torch.backends</span> <span class="kn">import</span> <span class="n">cudnn</span>

        <span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span>
        <span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cudnn.deterministic: </span><span class="si">{</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cudnn.benchmark: </span><span class="si">{</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">version</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cuDNN version: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">version</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random seed: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">init_seed</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">use_detect_anomaly</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_detect_anomaly</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set to use torch.autograd.detect_anomaly&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;use_amp&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">use_amp</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Use mixed precision training&quot;</span><span class="p">)</span>
        <span class="n">grad_scaler</span> <span class="o">=</span> <span class="n">GradScaler</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grad_scaler</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">hydra</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">netG</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Number of trainable params: </span><span class="si">{:.3f}</span><span class="s2"> million&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">num_trainable_params</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000000.0</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Distributed training</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="n">rank</span> <span class="o">%</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="n">device_id</span><span class="p">])</span>

    <span class="c1"># Optimizer</span>
    <span class="n">optimizer_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">optim</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer_class</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="o">**</span><span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">params</span>
    <span class="p">)</span>

    <span class="c1"># Scheduler</span>
    <span class="n">lr_scheduler_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
        <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">name</span>
    <span class="p">)</span>
    <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">lr_scheduler_class</span><span class="p">(</span>
        <span class="n">optimizer</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">params</span>
    <span class="p">)</span>

    <span class="c1"># DataLoader</span>
    <span class="n">data_loaders</span><span class="p">,</span> <span class="n">samplers</span> <span class="o">=</span> <span class="n">get_data_loaders</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">collate_fn</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

    <span class="n">set_epochs_based_on_max_steps_</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loaders</span><span class="p">[</span><span class="s2">&quot;train_no_dev&quot;</span><span class="p">]),</span> <span class="n">logger</span>
    <span class="p">)</span>

    <span class="c1"># Resume</span>
    <span class="n">_resume</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">resume</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">data_parallel</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Mlflow</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;file://&quot;</span> <span class="o">+</span> <span class="n">get_original_cwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/mlruns&quot;</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">experiment</span><span class="p">)</span>
        <span class="c1"># NOTE: disable tensorboard if mlflow is enabled</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using mlflow instead of tensorboard&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Tensorboard</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span><span class="n">to_absolute_path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">log_dir</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Scalers</span>
    <span class="k">if</span> <span class="s2">&quot;in_scaler_path&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">in_scaler_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">in_scaler</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">to_absolute_path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">in_scaler_path</span><span class="p">))</span>
        <span class="n">in_scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span>
            <span class="n">in_scaler</span><span class="o">.</span><span class="n">min_</span><span class="p">,</span> <span class="n">in_scaler</span><span class="o">.</span><span class="n">scale_</span><span class="p">,</span> <span class="n">in_scaler</span><span class="o">.</span><span class="n">data_min_</span><span class="p">,</span> <span class="n">in_scaler</span><span class="o">.</span><span class="n">data_max_</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">in_scaler</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;out_scaler_path&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">out_scaler_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_scaler</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">to_absolute_path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">out_scaler_path</span><span class="p">))</span>
        <span class="n">out_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">(</span>
            <span class="n">out_scaler</span><span class="o">.</span><span class="n">mean_</span><span class="p">,</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">var_</span><span class="p">,</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">scale_</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_scaler</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">,</span>
        <span class="n">lr_scheduler</span><span class="p">,</span>
        <span class="n">grad_scaler</span><span class="p">,</span>
        <span class="n">data_loaders</span><span class="p">,</span>
        <span class="n">samplers</span><span class="p">,</span>
        <span class="n">writer</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">,</span>
        <span class="n">in_scaler</span><span class="p">,</span>
        <span class="n">out_scaler</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="k">def</span> <span class="nf">setup_gan</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn_default</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setup for training GAN</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict): configuration for training</span>
<span class="sd">        device (torch.device): device to use for training</span>
<span class="sd">        collate_fn (callable, optional): collate function. Defaults to collate_fn_default.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple): tuple containing model, optimizer, learning rate scheduler,</span>
<span class="sd">            data loaders, tensorboard writer, logger, and scalers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">getLogger</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyTorch version: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="kn">from</span> <span class="nn">torch.backends</span> <span class="kn">import</span> <span class="n">cudnn</span>

        <span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span>
        <span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cudnn.deterministic: </span><span class="si">{</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cudnn.benchmark: </span><span class="si">{</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">version</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cuDNN version: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">version</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random seed: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">init_seed</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">use_detect_anomaly</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_detect_anomaly</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set to use torch.autograd.detect_anomaly&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;use_amp&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">use_amp</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Use mixed precision training&quot;</span><span class="p">)</span>
        <span class="n">grad_scaler</span> <span class="o">=</span> <span class="n">GradScaler</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grad_scaler</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Model G</span>
    <span class="n">netG</span> <span class="o">=</span> <span class="n">hydra</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">netG</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">netG</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;[Generator] Number of trainable params: </span><span class="si">{:.3f}</span><span class="s2"> million&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">num_trainable_params</span><span class="p">(</span><span class="n">netG</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000000.0</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="n">rank</span> <span class="o">%</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span>
        <span class="n">netG</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="n">device_id</span><span class="p">])</span>

    <span class="c1"># Optimizer and LR scheduler for G</span>
    <span class="n">optG</span><span class="p">,</span> <span class="n">schedulerG</span> <span class="o">=</span> <span class="n">_instantiate_optim</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">netG</span><span class="p">,</span> <span class="n">netG</span><span class="p">)</span>

    <span class="c1"># Model D</span>
    <span class="n">netD</span> <span class="o">=</span> <span class="n">hydra</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">netD</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">netD</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;[Discriminator] Number of trainable params: </span><span class="si">{:.3f}</span><span class="s2"> million&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">num_trainable_params</span><span class="p">(</span><span class="n">netD</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000000.0</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="n">rank</span> <span class="o">%</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span>
        <span class="n">netD</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span><span class="n">netD</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="n">device_id</span><span class="p">])</span>

    <span class="c1"># Optimizer and LR scheduler for D</span>
    <span class="n">optD</span><span class="p">,</span> <span class="n">schedulerD</span> <span class="o">=</span> <span class="n">_instantiate_optim</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">netD</span><span class="p">,</span> <span class="n">netD</span><span class="p">)</span>

    <span class="c1"># DataLoader</span>
    <span class="n">data_loaders</span><span class="p">,</span> <span class="n">samplers</span> <span class="o">=</span> <span class="n">get_data_loaders</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">collate_fn</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

    <span class="n">set_epochs_based_on_max_steps_</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loaders</span><span class="p">[</span><span class="s2">&quot;train_no_dev&quot;</span><span class="p">]),</span> <span class="n">logger</span>
    <span class="p">)</span>

    <span class="c1"># Resume</span>
    <span class="n">_resume</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">resume</span><span class="o">.</span><span class="n">netG</span><span class="p">,</span> <span class="n">netG</span><span class="p">,</span> <span class="n">optG</span><span class="p">,</span> <span class="n">schedulerG</span><span class="p">)</span>
    <span class="n">_resume</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">resume</span><span class="o">.</span><span class="n">netD</span><span class="p">,</span> <span class="n">netD</span><span class="p">,</span> <span class="n">optD</span><span class="p">,</span> <span class="n">schedulerD</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">data_parallel</span><span class="p">:</span>
        <span class="n">netG</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">netG</span><span class="p">)</span>
        <span class="n">netD</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">netD</span><span class="p">)</span>

    <span class="c1"># Mlflow</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;file://&quot;</span> <span class="o">+</span> <span class="n">get_original_cwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/mlruns&quot;</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">mlflow</span><span class="o">.</span><span class="n">experiment</span><span class="p">)</span>
        <span class="c1"># NOTE: disable tensorboard if mlflow is enabled</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using mlflow instead of tensorboard&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Tensorboard</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span><span class="n">to_absolute_path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">log_dir</span><span class="p">))</span>

    <span class="c1"># Scalers</span>
    <span class="k">if</span> <span class="s2">&quot;in_scaler_path&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">in_scaler_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">in_scaler</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">to_absolute_path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">in_scaler_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_scaler</span><span class="p">,</span> <span class="n">SKMinMaxScaler</span><span class="p">):</span>
            <span class="n">in_scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span>
                <span class="n">in_scaler</span><span class="o">.</span><span class="n">min_</span><span class="p">,</span>
                <span class="n">in_scaler</span><span class="o">.</span><span class="n">scale_</span><span class="p">,</span>
                <span class="n">in_scaler</span><span class="o">.</span><span class="n">data_min_</span><span class="p">,</span>
                <span class="n">in_scaler</span><span class="o">.</span><span class="n">data_max_</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">in_scaler</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;out_scaler_path&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">out_scaler_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_scaler</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">to_absolute_path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">out_scaler_path</span><span class="p">))</span>
        <span class="n">out_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">(</span>
            <span class="n">out_scaler</span><span class="o">.</span><span class="n">mean_</span><span class="p">,</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">var_</span><span class="p">,</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">scale_</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_scaler</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">optG</span><span class="p">,</span> <span class="n">schedulerG</span><span class="p">),</span>
        <span class="p">(</span><span class="n">netD</span><span class="p">,</span> <span class="n">optD</span><span class="p">,</span> <span class="n">schedulerD</span><span class="p">),</span>
        <span class="n">grad_scaler</span><span class="p">,</span>
        <span class="n">data_loaders</span><span class="p">,</span>
        <span class="n">samplers</span><span class="p">,</span>
        <span class="n">writer</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">,</span>
        <span class="n">in_scaler</span><span class="p">,</span>
        <span class="n">out_scaler</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">save_configs</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">to_absolute_path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">out_dir</span><span class="p">))</span>
    <span class="n">out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_dir</span> <span class="o">/</span> <span class="s2">&quot;model.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">OmegaConf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_dir</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">OmegaConf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_resf0_config</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">in_scaler</span><span class="p">,</span> <span class="n">out_scaler</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking model configs for residual F0 prediction&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">in_scaler</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">out_scaler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;in_scaler and out_scaler must be specified&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">DDP</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span>

    <span class="n">in_lf0_idx</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">in_lf0_idx</span>
    <span class="n">in_rest_idx</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">in_rest_idx</span>
    <span class="n">out_lf0_idx</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">out_lf0_idx</span>
    <span class="k">if</span> <span class="n">in_lf0_idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">in_rest_idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">out_lf0_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;in_lf0_idx, in_rest_idx and out_lf0_idx must be specified&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;in_lf0_idx: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">in_lf0_idx</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;in_rest_idx: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">in_rest_idx</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;out_lf0_idx: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out_lf0_idx</span><span class="p">)</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;in_lf0_idx&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">in_lf0_idx</span> <span class="o">!=</span> <span class="n">in_lf0_idx</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;in_lf0_idx in model and data config must be same&quot;</span><span class="p">,</span>
                <span class="n">model</span><span class="o">.</span><span class="n">in_lf0_idx</span><span class="p">,</span>
                <span class="n">in_lf0_idx</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;out_lf0_idx&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">out_lf0_idx</span> <span class="o">!=</span> <span class="n">out_lf0_idx</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;out_lf0_idx in model and data config must be same&quot;</span><span class="p">,</span>
                <span class="n">model</span><span class="o">.</span><span class="n">out_lf0_idx</span><span class="p">,</span>
                <span class="n">out_lf0_idx</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;in_lf0_min&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;in_lf0_max&quot;</span><span class="p">):</span>
        <span class="c1"># Inject values from the input scaler</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">in_lf0_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">in_lf0_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">in_lf0_min</span> <span class="o">=</span> <span class="n">in_scaler</span><span class="o">.</span><span class="n">data_min_</span><span class="p">[</span><span class="n">in_lf0_idx</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">in_lf0_max</span> <span class="o">=</span> <span class="n">in_scaler</span><span class="o">.</span><span class="n">data_max_</span><span class="p">[</span><span class="n">in_lf0_idx</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;in_lf0_min: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">in_lf0_min</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;in_lf0_max: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">in_lf0_max</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_min</span><span class="p">,</span> <span class="n">in_scaler</span><span class="o">.</span><span class="n">data_min_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_idx</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;in_lf0_min is set to </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_min</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but should be </span><span class="si">{</span><span class="n">in_scaler</span><span class="o">.</span><span class="n">data_min_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_max</span><span class="p">,</span> <span class="n">in_scaler</span><span class="o">.</span><span class="n">data_max_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_idx</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;in_lf0_max is set to </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_max</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but should be </span><span class="si">{</span><span class="n">in_scaler</span><span class="o">.</span><span class="n">data_max_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;out_lf0_mean&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;out_lf0_scale&quot;</span><span class="p">):</span>
        <span class="c1"># Inject values from the output scaler</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">out_lf0_mean</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">out_lf0_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">out_lf0_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">out_scaler</span><span class="o">.</span><span class="n">mean_</span><span class="p">[</span><span class="n">out_lf0_idx</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">out_lf0_scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">out_scaler</span><span class="o">.</span><span class="n">scale_</span><span class="p">[</span><span class="n">out_lf0_idx</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;model.out_lf0_mean: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">out_lf0_mean</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;model.out_lf0_scale: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">out_lf0_scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_mean</span><span class="p">,</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">mean_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_idx</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;out_lf0_mean is set to </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_mean</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but should be </span><span class="si">{</span><span class="n">out_scaler</span><span class="o">.</span><span class="n">mean_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_scale</span><span class="p">,</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">scale_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_idx</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;out_lf0_scale is set to </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_scale</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but should be </span><span class="si">{</span><span class="n">out_scaler</span><span class="o">.</span><span class="n">scale_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">in_lf0_idx</span> <span class="o">==</span> <span class="n">in_lf0_idx</span>
            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;in_lf0_min&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;out_lf0_mean&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">If you are 100% sure that you set model.in_lf0_idx and model.out_lf0_idx correctly,</span>
<span class="s2">Please consider the following parameters in your model config:</span>

<span class="s2">    in_lf0_idx: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_idx</span><span class="si">}</span>
<span class="s2">    out_lf0_idx: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_idx</span><span class="si">}</span>
<span class="s2">    in_lf0_min: </span><span class="si">{</span><span class="n">in_scaler</span><span class="o">.</span><span class="n">data_min_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_idx</span><span class="p">]</span><span class="si">}</span>
<span class="s2">    in_lf0_max: </span><span class="si">{</span><span class="n">in_scaler</span><span class="o">.</span><span class="n">data_max_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">in_lf0_idx</span><span class="p">]</span><span class="si">}</span>
<span class="s2">    out_lf0_mean: </span><span class="si">{</span><span class="n">out_scaler</span><span class="o">.</span><span class="n">mean_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_idx</span><span class="p">]</span><span class="si">}</span>
<span class="s2">    out_lf0_scale: </span><span class="si">{</span><span class="n">out_scaler</span><span class="o">.</span><span class="n">scale_</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">out_lf0_idx</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model config has wrong configurations.&quot;</span><span class="p">)</span>

    <span class="c1"># Overwrite the parameters to the config</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;in_lf0_min&quot;</span><span class="p">,</span> <span class="s2">&quot;in_lf0_max&quot;</span><span class="p">,</span> <span class="s2">&quot;out_lf0_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;out_lf0_scale&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">netG</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>


<div class="viewcode-block" id="compute_pitch_regularization_weight">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.compute_pitch_regularization_weight.html#nnsvs.train_util.compute_pitch_regularization_weight">[docs]</a>
<span class="k">def</span> <span class="nf">compute_pitch_regularization_weight</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">decay_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">max_w</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute pitch regularization weight given note segments</span>

<span class="sd">    Args:</span>
<span class="sd">        segments (list): list of note (start, end) indices</span>
<span class="sd">        N (int): number of frames</span>
<span class="sd">        decay_size (int): size of the decay window</span>
<span class="sd">        max_w (float): maximum weight</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: weights of shape (N,)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span>
        <span class="n">w</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_w</span>
        <span class="k">if</span> <span class="n">L</span> <span class="o">&gt;</span> <span class="n">decay_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">w</span><span class="p">[</span><span class="n">s</span> <span class="p">:</span> <span class="n">s</span> <span class="o">+</span> <span class="n">decay_size</span><span class="p">]</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">decay_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">decay_size</span>
            <span class="n">w</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="n">decay_size</span> <span class="p">:</span> <span class="n">e</span><span class="p">]</span> <span class="o">*=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">decay_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">decay_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For shote notes (less than decay_size*0.01 sec) we don&#39;t use pitch regularization</span>
            <span class="n">w</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">w</span></div>



<div class="viewcode-block" id="compute_batch_pitch_regularization_weight">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.compute_batch_pitch_regularization_weight.html#nnsvs.train_util.compute_batch_pitch_regularization_weight">[docs]</a>
<span class="k">def</span> <span class="nf">compute_batch_pitch_regularization_weight</span><span class="p">(</span><span class="n">lf0_score_denorm</span><span class="p">,</span> <span class="n">decay_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch version of computing pitch regularization weight</span>

<span class="sd">    Args:</span>
<span class="sd">        lf0_score_denorm (Tensor): (B, T)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: weights of shape (B, N, 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">B</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">lf0_score_denorm</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lf0_score_denorm</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lf0_score_denorm</span><span class="p">)):</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">note_segments</span><span class="p">(</span><span class="n">lf0_score_denorm</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">compute_pitch_regularization_weight</span><span class="p">(</span>
            <span class="n">segments</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">decay_size</span><span class="o">=</span><span class="n">decay_size</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="compute_distortions">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.compute_distortions.html#nnsvs.train_util.compute_distortions">[docs]</a>
<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">compute_distortions</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">,</span> <span class="n">out_feats</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">out_scaler</span><span class="p">,</span> <span class="n">model_config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute distortion measures between predicted and ground-truth acoustic features</span>


<span class="sd">    Args:</span>
<span class="sd">        pred_out_feats (nn.Tensor): predicted acoustic features</span>
<span class="sd">        out_feats (nn.Tensor): ground-truth acoustic features</span>
<span class="sd">        lengths (nn.Tensor): lengths of the sequences</span>
<span class="sd">        out_scaler (nn.Module): scaler to denormalize features</span>
<span class="sd">        model_config (dict): model configuration</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: a dict that includes MCD for mgc/bap, V/UV error and F0 RMSE</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_feats</span> <span class="o">=</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">out_feats</span><span class="p">)</span>
    <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">)</span>
    <span class="n">out_streams</span> <span class="o">=</span> <span class="n">get_static_features</span><span class="p">(</span>
        <span class="n">out_feats</span><span class="p">,</span>
        <span class="n">model_config</span><span class="o">.</span><span class="n">num_windows</span><span class="p">,</span>
        <span class="n">model_config</span><span class="o">.</span><span class="n">stream_sizes</span><span class="p">,</span>
        <span class="n">model_config</span><span class="o">.</span><span class="n">has_dynamic_features</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">pred_out_streams</span> <span class="o">=</span> <span class="n">get_static_features</span><span class="p">(</span>
        <span class="n">pred_out_feats</span><span class="p">,</span>
        <span class="n">model_config</span><span class="o">.</span><span class="n">num_windows</span><span class="p">,</span>
        <span class="n">model_config</span><span class="o">.</span><span class="n">stream_sizes</span><span class="p">,</span>
        <span class="n">model_config</span><span class="o">.</span><span class="n">has_dynamic_features</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_streams</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">mgc</span><span class="p">,</span> <span class="n">lf0</span><span class="p">,</span> <span class="n">vuv</span><span class="p">,</span> <span class="n">bap</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">out_streams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">out_streams</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">out_streams</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">out_streams</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">pred_mgc</span><span class="p">,</span> <span class="n">pred_lf0</span><span class="p">,</span> <span class="n">pred_vuv</span><span class="p">,</span> <span class="n">pred_bap</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pred_out_streams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">pred_out_streams</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">pred_out_streams</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">pred_out_streams</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_streams</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">mgc</span><span class="p">,</span> <span class="n">lf0</span><span class="p">,</span> <span class="n">vuv</span> <span class="o">=</span> <span class="n">out_streams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out_streams</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_streams</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pred_mgc</span><span class="p">,</span> <span class="n">pred_lf0</span><span class="p">,</span> <span class="n">pred_vuv</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pred_out_streams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">pred_out_streams</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">pred_out_streams</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">bap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pred_bap</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># binarize vuv</span>
    <span class="n">vuv</span><span class="p">,</span> <span class="n">pred_vuv</span> <span class="o">=</span> <span class="p">(</span><span class="n">vuv</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="p">(</span><span class="n">pred_vuv</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ObjEval_MGC_MCD&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">melcd</span><span class="p">(</span>
            <span class="n">mgc</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">pred_mgc</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">lengths</span><span class="o">=</span><span class="n">lengths</span>
        <span class="p">),</span>
        <span class="s2">&quot;ObjEval_VUV_ERR&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">vuv_error</span><span class="p">(</span><span class="n">vuv</span><span class="p">,</span> <span class="n">pred_vuv</span><span class="p">,</span> <span class="n">lengths</span><span class="o">=</span><span class="n">lengths</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">bap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dist</span><span class="p">[</span><span class="s2">&quot;ObjEval_BAP_MCD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">melcd</span><span class="p">(</span><span class="n">bap</span><span class="p">,</span> <span class="n">pred_bap</span><span class="p">,</span> <span class="n">lengths</span><span class="o">=</span><span class="n">lengths</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">f0_mse</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">lf0_mean_squared_error</span><span class="p">(</span>
            <span class="n">lf0</span><span class="p">,</span> <span class="n">vuv</span><span class="p">,</span> <span class="n">pred_lf0</span><span class="p">,</span> <span class="n">pred_vuv</span><span class="p">,</span> <span class="n">lengths</span><span class="o">=</span><span class="n">lengths</span><span class="p">,</span> <span class="n">linear_domain</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">dist</span><span class="p">[</span><span class="s2">&quot;ObjEval_F0_RMSE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">f0_mse</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">dist</span></div>



<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">eval_pitch_model</span><span class="p">(</span>
    <span class="n">phase</span><span class="p">,</span>
    <span class="n">step</span><span class="p">,</span>
    <span class="n">netG</span><span class="p">,</span>
    <span class="n">in_feats</span><span class="p">,</span>
    <span class="n">out_feats</span><span class="p">,</span>
    <span class="n">lengths</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">,</span>
    <span class="n">out_scaler</span><span class="p">,</span>
    <span class="n">writer</span><span class="p">,</span>
    <span class="n">sr</span><span class="p">,</span>
    <span class="n">lf0_score_denorm</span><span class="p">,</span>
    <span class="n">max_num_eval_utts</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># make sure to be in eval mode</span>
    <span class="n">netG</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">prediction_type</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">netG</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">DDP</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">netG</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">utt_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">max_num_eval_utts</span><span class="p">))</span>
    <span class="n">utt_indices</span> <span class="o">=</span> <span class="n">utt_indices</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">utt_indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_feats</span><span class="p">))]</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">has_dynamic_features</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">utt_idx</span> <span class="ow">in</span> <span class="n">utt_indices</span><span class="p">:</span>
        <span class="n">out_feats_denorm_</span> <span class="o">=</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span>
            <span class="n">out_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">lf0</span> <span class="o">=</span> <span class="n">out_feats_denorm_</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lf0_score_denorm_</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">lf0_score_denorm</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Run forward</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="n">netG</span><span class="p">(</span>
            <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
            <span class="n">out_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># ResF0 case</span>
        <span class="k">if</span> <span class="n">netG</span><span class="o">.</span><span class="n">has_residual_lf0_prediction</span><span class="p">():</span>
            <span class="n">outs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">outs</span>

        <span class="k">if</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="n">PredictionType</span><span class="o">.</span><span class="n">PROBABILISTIC</span><span class="p">:</span>
            <span class="n">pi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">outs</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">mdn_get_most_probable_sigma_and_mu</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">outs</span>
        <span class="c1"># NOTE: multiple outputs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">pred_out_feats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">pred_out_feats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred_out_feats</span><span class="p">]</span>

        <span class="c1"># Run inference</span>
        <span class="k">if</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="n">PredictionType</span><span class="o">.</span><span class="n">PROBABILISTIC</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">DDP</span><span class="p">):</span>
                <span class="n">inference_out_feats</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inference_out_feats</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">DDP</span><span class="p">):</span>
                <span class="n">inference_out_feats</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inference_out_feats</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
        <span class="n">pred_out_feats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inference_out_feats</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pred_out_feats_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">):</span>
            <span class="n">pred_out_feats_</span> <span class="o">=</span> <span class="n">pred_out_feats_</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">pred_lf0</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">out_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">pred_out_feats_</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">in_feats</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">_utt</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">utt_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">_inference&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">_utt</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">utt_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">_forward&quot;</span>

            <span class="c1"># Continuous log-F0</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">timeaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lf0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.005</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">timeaxis</span><span class="p">,</span> <span class="n">lf0</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target log-F0&quot;</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">timeaxis</span><span class="p">,</span>
                <span class="n">pred_lf0</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted log-F0&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">timeaxis</span><span class="p">,</span>
                <span class="n">lf0_score_denorm_</span><span class="p">,</span>
                <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Note log-F0&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [sec]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Log-frequency [Hz]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeaxis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
                <span class="nb">min</span><span class="p">(</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">lf0_score_denorm_</span><span class="p">[</span><span class="n">lf0_score_denorm_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">lf0</span><span class="p">),</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">lf0_score_denorm_</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lf0</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/ContinuousLogF0&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># F0</span>
            <span class="n">lf0_score</span> <span class="o">=</span> <span class="n">lf0_score_denorm_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">note_indices</span> <span class="o">=</span> <span class="n">lf0_score</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">lf0_score</span><span class="p">[</span><span class="n">note_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">[</span><span class="n">note_indices</span><span class="p">])</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">timeaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lf0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.005</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">timeaxis</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">),</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target F0&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">timeaxis</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">),</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted F0&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">timeaxis</span><span class="p">,</span> <span class="n">lf0_score</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Note F0&quot;</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [sec]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency [Hz]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeaxis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
                <span class="nb">min</span><span class="p">(</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">[</span><span class="n">lf0_score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)),</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/F0&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">synthesize</span><span class="p">(</span>
    <span class="n">device</span><span class="p">,</span>
    <span class="n">mgc</span><span class="p">,</span>
    <span class="n">lf0</span><span class="p">,</span>
    <span class="n">vuv</span><span class="p">,</span>
    <span class="n">bap</span><span class="p">,</span>
    <span class="n">sr</span><span class="p">,</span>
    <span class="n">use_world_codec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">vuv_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">vocoder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">vocoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">is_usfgan</span> <span class="o">=</span> <span class="s2">&quot;generator&quot;</span> <span class="ow">in</span> <span class="n">vocoder_config</span> <span class="ow">and</span> <span class="s2">&quot;discriminator&quot;</span> <span class="ow">in</span> <span class="n">vocoder_config</span>
        <span class="k">assert</span> <span class="n">vocoder_in_scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_usfgan</span><span class="p">:</span>
            <span class="c1"># NOTE: So far vocoder models are trained on binary V/UV features</span>
            <span class="n">vuv</span> <span class="o">=</span> <span class="p">(</span><span class="n">vuv</span> <span class="o">&gt;</span> <span class="n">vuv_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">voc_inp</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
                    <span class="n">vocoder_in_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">mgc</span><span class="p">,</span> <span class="n">lf0</span><span class="p">,</span> <span class="n">vuv</span><span class="p">,</span> <span class="n">bap</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">float</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">wav</span> <span class="o">=</span> <span class="n">vocoder</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">voc_inp</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fftlen</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">get_cheaptrick_fft_size</span><span class="p">(</span><span class="n">sr</span><span class="p">)</span>
            <span class="n">use_mcep_aperiodicity</span> <span class="o">=</span> <span class="n">bap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span>
            <span class="k">if</span> <span class="n">use_mcep_aperiodicity</span><span class="p">:</span>
                <span class="n">mcep_aperiodicity_order</span> <span class="o">=</span> <span class="n">bap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">pysptk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">mcepalpha</span><span class="p">(</span><span class="n">sr</span><span class="p">)</span>
                <span class="n">aperiodicity</span> <span class="o">=</span> <span class="n">pysptk</span><span class="o">.</span><span class="n">mc2sp</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">bap</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                    <span class="n">fftlen</span><span class="o">=</span><span class="n">fftlen</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aperiodicity</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">decode_aperiodicity</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">bap</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">sr</span><span class="p">,</span> <span class="n">fftlen</span>
                <span class="p">)</span>
            <span class="c1"># fill aperiodicity with ones for unvoiced regions</span>
            <span class="n">aperiodicity</span><span class="p">[</span><span class="n">vuv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">vuv_threshold</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="c1"># WORLD fails catastrophically for out of range aperiodicity</span>
            <span class="n">aperiodicity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">aperiodicity</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="c1"># back to bap</span>
            <span class="k">if</span> <span class="n">use_mcep_aperiodicity</span><span class="p">:</span>
                <span class="n">bap</span> <span class="o">=</span> <span class="n">pysptk</span><span class="o">.</span><span class="n">sp2mc</span><span class="p">(</span>
                    <span class="n">aperiodicity</span><span class="p">,</span>
                    <span class="n">order</span><span class="o">=</span><span class="n">mcep_aperiodicity_order</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bap</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">code_aperiodicity</span><span class="p">(</span><span class="n">aperiodicity</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="n">aux_feats</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
                    <span class="n">vocoder_in_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">mgc</span><span class="p">,</span> <span class="n">bap</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">float</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">contf0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vocoder_config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sine_f0_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;contf0&quot;</span><span class="p">,</span> <span class="s2">&quot;cf0&quot;</span><span class="p">]:</span>
                <span class="n">f0_inp</span> <span class="o">=</span> <span class="n">contf0</span>
            <span class="k">elif</span> <span class="n">vocoder_config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sine_f0_type</span> <span class="o">==</span> <span class="s2">&quot;f0&quot;</span><span class="p">:</span>
                <span class="n">f0_inp</span> <span class="o">=</span> <span class="n">contf0</span>
                <span class="n">f0_inp</span><span class="p">[</span><span class="n">vuv</span> <span class="o">&lt;</span> <span class="n">vuv_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">wav</span> <span class="o">=</span> <span class="n">vocoder</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">f0_inp</span><span class="p">,</span> <span class="n">aux_feats</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback to WORLD</span>
        <span class="n">f0</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="n">aperiodicity</span> <span class="o">=</span> <span class="n">gen_world_params</span><span class="p">(</span>
            <span class="n">mgc</span><span class="p">,</span>
            <span class="n">lf0</span><span class="p">,</span>
            <span class="n">vuv</span><span class="p">,</span>
            <span class="n">bap</span><span class="p">,</span>
            <span class="n">sr</span><span class="p">,</span>
            <span class="n">use_world_codec</span><span class="o">=</span><span class="n">use_world_codec</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">wav</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">synthesize</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">,</span> <span class="n">aperiodicity</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wav</span>


<span class="k">def</span> <span class="nf">synthesize_from_mel</span><span class="p">(</span>
    <span class="n">device</span><span class="p">,</span>
    <span class="n">logmel</span><span class="p">,</span>
    <span class="n">lf0</span><span class="p">,</span>
    <span class="n">vuv</span><span class="p">,</span>
    <span class="n">sr</span><span class="p">,</span>
    <span class="n">vuv_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">vocoder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">vocoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">is_usfgan</span> <span class="o">=</span> <span class="s2">&quot;generator&quot;</span> <span class="ow">in</span> <span class="n">vocoder_config</span> <span class="ow">and</span> <span class="s2">&quot;discriminator&quot;</span> <span class="ow">in</span> <span class="n">vocoder_config</span>
        <span class="k">assert</span> <span class="n">vocoder_in_scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_usfgan</span><span class="p">:</span>
            <span class="c1"># NOTE: So far vocoder models are trained on binary V/UV features</span>
            <span class="n">vuv</span> <span class="o">=</span> <span class="p">(</span><span class="n">vuv</span> <span class="o">&gt;</span> <span class="n">vuv_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">voc_inp</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
                    <span class="n">vocoder_in_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">logmel</span><span class="p">,</span> <span class="n">lf0</span><span class="p">,</span> <span class="n">vuv</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">float</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">wav</span> <span class="o">=</span> <span class="n">vocoder</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">voc_inp</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NOTE: So far vocoder models are trained on binary V/UV features</span>
            <span class="n">vuv</span> <span class="o">=</span> <span class="p">(</span><span class="n">vuv</span> <span class="o">&gt;</span> <span class="n">vuv_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">aux_feats</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">vocoder_in_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">logmel</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">contf0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vocoder_config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sine_f0_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;contf0&quot;</span><span class="p">,</span> <span class="s2">&quot;cf0&quot;</span><span class="p">]:</span>
                <span class="n">f0_inp</span> <span class="o">=</span> <span class="n">contf0</span>
            <span class="k">elif</span> <span class="n">vocoder_config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sine_f0_type</span> <span class="o">==</span> <span class="s2">&quot;f0&quot;</span><span class="p">:</span>
                <span class="n">f0_inp</span> <span class="o">=</span> <span class="n">contf0</span>
                <span class="n">f0_inp</span><span class="p">[</span><span class="n">vuv</span> <span class="o">&lt;</span> <span class="n">vuv_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">wav</span> <span class="o">=</span> <span class="n">vocoder</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">f0_inp</span><span class="p">,</span> <span class="n">aux_feats</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not supported&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wav</span>


<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">eval_model</span><span class="p">(</span>
    <span class="n">phase</span><span class="p">,</span>
    <span class="n">step</span><span class="p">,</span>
    <span class="n">netG</span><span class="p">,</span>
    <span class="n">in_feats</span><span class="p">,</span>
    <span class="n">out_feats</span><span class="p">,</span>
    <span class="n">lengths</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">,</span>
    <span class="n">out_scaler</span><span class="p">,</span>
    <span class="n">writer</span><span class="p">,</span>
    <span class="n">sr</span><span class="p">,</span>
    <span class="n">lf0_score_denorm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">trajectory_smoothing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">trajectory_smoothing_cutoff</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">trajectory_smoothing_cutoff_f0</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">use_world_codec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">vocoder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vuv_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">max_num_eval_utts</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">stream_sizes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">eval_spss_model</span><span class="p">(</span>
            <span class="n">phase</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
            <span class="n">netG</span><span class="o">=</span><span class="n">netG</span><span class="p">,</span>
            <span class="n">in_feats</span><span class="o">=</span><span class="n">in_feats</span><span class="p">,</span>
            <span class="n">out_feats</span><span class="o">=</span><span class="n">out_feats</span><span class="p">,</span>
            <span class="n">lengths</span><span class="o">=</span><span class="n">lengths</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span>
            <span class="n">out_scaler</span><span class="o">=</span><span class="n">out_scaler</span><span class="p">,</span>
            <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span>
            <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
            <span class="n">lf0_score_denorm</span><span class="o">=</span><span class="n">lf0_score_denorm</span><span class="p">,</span>
            <span class="n">trajectory_smoothing</span><span class="o">=</span><span class="n">trajectory_smoothing</span><span class="p">,</span>
            <span class="n">trajectory_smoothing_cutoff</span><span class="o">=</span><span class="n">trajectory_smoothing_cutoff</span><span class="p">,</span>
            <span class="n">trajectory_smoothing_cutoff_f0</span><span class="o">=</span><span class="n">trajectory_smoothing_cutoff_f0</span><span class="p">,</span>
            <span class="n">use_world_codec</span><span class="o">=</span><span class="n">use_world_codec</span><span class="p">,</span>
            <span class="n">vocoder</span><span class="o">=</span><span class="n">vocoder</span><span class="p">,</span>
            <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="n">vocoder_in_scaler</span><span class="p">,</span>
            <span class="n">vocoder_config</span><span class="o">=</span><span class="n">vocoder_config</span><span class="p">,</span>
            <span class="n">vuv_threshold</span><span class="o">=</span><span class="n">vuv_threshold</span><span class="p">,</span>
            <span class="n">max_num_eval_utts</span><span class="o">=</span><span class="n">max_num_eval_utts</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">eval_mel_model</span><span class="p">(</span>
            <span class="n">phase</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
            <span class="n">netG</span><span class="o">=</span><span class="n">netG</span><span class="p">,</span>
            <span class="n">in_feats</span><span class="o">=</span><span class="n">in_feats</span><span class="p">,</span>
            <span class="n">out_feats</span><span class="o">=</span><span class="n">out_feats</span><span class="p">,</span>
            <span class="n">lengths</span><span class="o">=</span><span class="n">lengths</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span>
            <span class="n">out_scaler</span><span class="o">=</span><span class="n">out_scaler</span><span class="p">,</span>
            <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span>
            <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
            <span class="n">lf0_score_denorm</span><span class="o">=</span><span class="n">lf0_score_denorm</span><span class="p">,</span>
            <span class="n">vocoder</span><span class="o">=</span><span class="n">vocoder</span><span class="p">,</span>
            <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="n">vocoder_in_scaler</span><span class="p">,</span>
            <span class="n">vocoder_config</span><span class="o">=</span><span class="n">vocoder_config</span><span class="p">,</span>
            <span class="n">vuv_threshold</span><span class="o">=</span><span class="n">vuv_threshold</span><span class="p">,</span>
            <span class="n">max_num_eval_utts</span><span class="o">=</span><span class="n">max_num_eval_utts</span><span class="p">,</span>
        <span class="p">)</span>


<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">eval_spss_model</span><span class="p">(</span>
    <span class="n">phase</span><span class="p">,</span>
    <span class="n">step</span><span class="p">,</span>
    <span class="n">netG</span><span class="p">,</span>
    <span class="n">in_feats</span><span class="p">,</span>
    <span class="n">out_feats</span><span class="p">,</span>
    <span class="n">lengths</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">,</span>
    <span class="n">out_scaler</span><span class="p">,</span>
    <span class="n">writer</span><span class="p">,</span>
    <span class="n">sr</span><span class="p">,</span>
    <span class="n">lf0_score_denorm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">trajectory_smoothing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">trajectory_smoothing_cutoff</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">trajectory_smoothing_cutoff_f0</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">use_world_codec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">vocoder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vuv_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">max_num_eval_utts</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># make sure to be in eval mode</span>
    <span class="n">netG</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">prediction_type</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">netG</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">DDP</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">netG</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">utt_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">max_num_eval_utts</span><span class="p">))</span>
    <span class="n">utt_indices</span> <span class="o">=</span> <span class="n">utt_indices</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">utt_indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_feats</span><span class="p">))]</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">has_dynamic_features</span><span class="p">):</span>
        <span class="n">static_stream_sizes</span> <span class="o">=</span> <span class="n">get_static_stream_sizes</span><span class="p">(</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">stream_sizes</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">has_dynamic_features</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">num_windows</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">static_stream_sizes</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">stream_sizes</span>

    <span class="n">rawsp_output</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">utt_idx</span> <span class="ow">in</span> <span class="n">utt_indices</span><span class="p">:</span>
        <span class="n">out_feats_denorm_</span> <span class="o">=</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span>
            <span class="n">out_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">mgc</span><span class="p">,</span> <span class="n">lf0</span><span class="p">,</span> <span class="n">vuv</span><span class="p">,</span> <span class="n">bap</span> <span class="o">=</span> <span class="n">get_static_features</span><span class="p">(</span>
            <span class="n">out_feats_denorm_</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">num_windows</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">stream_sizes</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">has_dynamic_features</span><span class="p">,</span>
        <span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">mgc</span> <span class="o">=</span> <span class="n">mgc</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">lf0</span> <span class="o">=</span> <span class="n">lf0</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">vuv</span> <span class="o">=</span> <span class="n">vuv</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">bap</span> <span class="o">=</span> <span class="n">bap</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lf0_score_denorm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lf0_score_denorm_</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">lf0_score_denorm</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lf0_score_denorm_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># log spectrogram case</span>
        <span class="n">rawsp_output</span> <span class="o">=</span> <span class="n">mgc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">128</span>
        <span class="k">if</span> <span class="n">rawsp_output</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mgc</span><span class="p">)</span>
            <span class="c1"># NOTE: 60-dim mgc is asummed</span>
            <span class="n">mgc</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">code_spectral_envelope</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">use_world_codec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">wav</span> <span class="o">=</span> <span class="n">synthesize</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="n">in_feats</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">mgc</span><span class="o">=</span><span class="n">mgc</span><span class="p">,</span>
            <span class="n">lf0</span><span class="o">=</span><span class="n">lf0</span><span class="p">,</span>
            <span class="n">vuv</span><span class="o">=</span><span class="n">vuv</span><span class="p">,</span>
            <span class="n">bap</span><span class="o">=</span><span class="n">bap</span><span class="p">,</span>
            <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
            <span class="n">use_world_codec</span><span class="o">=</span><span class="n">use_world_codec</span><span class="p">,</span>
            <span class="n">vuv_threshold</span><span class="o">=</span><span class="n">vuv_threshold</span><span class="p">,</span>
            <span class="n">vocoder</span><span class="o">=</span><span class="n">vocoder</span><span class="p">,</span>
            <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="n">vocoder_in_scaler</span><span class="p">,</span>
            <span class="n">vocoder_config</span><span class="o">=</span><span class="n">vocoder_config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">_utt</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">utt_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">_reference&quot;</span>
        <span class="n">wav</span> <span class="o">=</span> <span class="n">wav</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">wav</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">add_audio</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span>

        <span class="c1"># Run forward</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="n">netG</span><span class="p">(</span>
            <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
            <span class="n">out_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># ResF0 case</span>
        <span class="k">if</span> <span class="n">netG</span><span class="o">.</span><span class="n">has_residual_lf0_prediction</span><span class="p">():</span>
            <span class="n">outs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">outs</span>

        <span class="c1"># Hybrid</span>
        <span class="k">if</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="n">PredictionType</span><span class="o">.</span><span class="n">MULTISTREAM_HYBRID</span><span class="p">:</span>
            <span class="n">pred_mgc</span><span class="p">,</span> <span class="n">pred_lf0</span><span class="p">,</span> <span class="n">pred_vuv</span><span class="p">,</span> <span class="n">pred_bap</span> <span class="o">=</span> <span class="n">outs</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">pred_lf0</span> <span class="o">=</span> <span class="n">mdn_get_most_probable_sigma_and_mu</span><span class="p">(</span><span class="o">*</span><span class="n">pred_lf0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pred_lf0</span> <span class="o">=</span> <span class="n">pred_lf0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_mgc</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_mgc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">pred_mgc</span> <span class="o">=</span> <span class="n">mdn_get_most_probable_sigma_and_mu</span><span class="p">(</span><span class="o">*</span><span class="n">pred_mgc</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_mgc</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_mgc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pred_mgc</span> <span class="o">=</span> <span class="n">pred_mgc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_bap</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_bap</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">pred_bap</span> <span class="o">=</span> <span class="n">mdn_get_most_probable_sigma_and_mu</span><span class="p">(</span><span class="o">*</span><span class="n">pred_bap</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_bap</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_bap</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pred_bap</span> <span class="o">=</span> <span class="n">pred_bap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">pred_mgc</span><span class="p">,</span> <span class="n">pred_lf0</span><span class="p">,</span> <span class="n">pred_vuv</span><span class="p">,</span> <span class="n">pred_bap</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="n">PredictionType</span><span class="o">.</span><span class="n">PROBABILISTIC</span><span class="p">:</span>
            <span class="n">pi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">outs</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">mdn_get_most_probable_sigma_and_mu</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">outs</span>
        <span class="c1"># NOTE: multiple outputs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">pred_out_feats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">pred_out_feats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred_out_feats</span><span class="p">]</span>

        <span class="c1"># Run inference</span>
        <span class="k">if</span> <span class="n">prediction_type</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">PredictionType</span><span class="o">.</span><span class="n">PROBABILISTIC</span><span class="p">,</span>
            <span class="n">PredictionType</span><span class="o">.</span><span class="n">MULTISTREAM_HYBRID</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">DDP</span><span class="p">):</span>
                <span class="n">inference_out_feats</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inference_out_feats</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">DDP</span><span class="p">):</span>
                <span class="n">inference_out_feats</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inference_out_feats</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
        <span class="n">pred_out_feats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inference_out_feats</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pred_out_feats_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">):</span>
            <span class="n">pred_out_feats_</span> <span class="o">=</span> <span class="n">pred_out_feats_</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">pred_out_feats_denorm</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">out_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">pred_out_feats_</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">in_feats</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">has_dynamic_features</span><span class="p">):</span>
                <span class="c1"># (T, D_out) -&gt; (T, static_dim)</span>
                <span class="n">pred_out_feats_denorm</span> <span class="o">=</span> <span class="n">multi_stream_mlpg</span><span class="p">(</span>
                    <span class="n">pred_out_feats_denorm</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">out_scaler</span><span class="o">.</span><span class="n">scale_</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                    <span class="n">get_windows</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">num_windows</span><span class="p">),</span>
                    <span class="n">model_config</span><span class="o">.</span><span class="n">stream_sizes</span><span class="p">,</span>
                    <span class="n">model_config</span><span class="o">.</span><span class="n">has_dynamic_features</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">pred_mgc</span><span class="p">,</span> <span class="n">pred_lf0</span><span class="p">,</span> <span class="n">pred_vuv</span><span class="p">,</span> <span class="n">pred_bap</span> <span class="o">=</span> <span class="n">split_streams</span><span class="p">(</span>
                <span class="n">pred_out_feats_denorm</span><span class="p">,</span> <span class="n">static_stream_sizes</span>
            <span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>

            <span class="c1"># log spectrogram case</span>
            <span class="k">if</span> <span class="n">rawsp_output</span><span class="p">:</span>
                <span class="n">pred_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred_mgc</span><span class="p">)</span>
                <span class="c1"># NOTE: 60-dim mgc is asummed</span>
                <span class="n">pred_mgc</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">code_spectral_envelope</span><span class="p">(</span><span class="n">pred_sp</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pred_sp</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Remove high-frequency components of lf0/mgc/bap</span>
            <span class="c1"># NOTE: Useful to reduce high-frequency artifacts</span>
            <span class="k">if</span> <span class="n">trajectory_smoothing</span><span class="p">:</span>
                <span class="n">modfs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">0.005</span><span class="p">)</span>
                <span class="n">pred_lf0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowpass_filter</span><span class="p">(</span>
                    <span class="n">pred_lf0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">modfs</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">trajectory_smoothing_cutoff_f0</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_mgc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">pred_mgc</span><span class="p">[:,</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowpass_filter</span><span class="p">(</span>
                        <span class="n">pred_mgc</span><span class="p">[:,</span> <span class="n">d</span><span class="p">],</span> <span class="n">modfs</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">trajectory_smoothing_cutoff</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_bap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">pred_bap</span><span class="p">[:,</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowpass_filter</span><span class="p">(</span>
                        <span class="n">pred_bap</span><span class="p">[:,</span> <span class="n">d</span><span class="p">],</span> <span class="n">modfs</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">trajectory_smoothing_cutoff</span>
                    <span class="p">)</span>

            <span class="c1"># Generated sample</span>
            <span class="n">wav</span> <span class="o">=</span> <span class="n">synthesize</span><span class="p">(</span>
                <span class="n">device</span><span class="o">=</span><span class="n">in_feats</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="n">mgc</span><span class="o">=</span><span class="n">pred_mgc</span><span class="p">,</span>
                <span class="n">lf0</span><span class="o">=</span><span class="n">pred_lf0</span><span class="p">,</span>
                <span class="n">vuv</span><span class="o">=</span><span class="n">pred_vuv</span><span class="p">,</span>
                <span class="n">bap</span><span class="o">=</span><span class="n">pred_bap</span><span class="p">,</span>
                <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
                <span class="n">use_world_codec</span><span class="o">=</span><span class="n">use_world_codec</span><span class="p">,</span>
                <span class="n">vuv_threshold</span><span class="o">=</span><span class="n">vuv_threshold</span><span class="p">,</span>
                <span class="n">vocoder</span><span class="o">=</span><span class="n">vocoder</span><span class="p">,</span>
                <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="n">vocoder_in_scaler</span><span class="p">,</span>
                <span class="n">vocoder_config</span><span class="o">=</span><span class="n">vocoder_config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">wav</span> <span class="o">=</span> <span class="n">wav</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">wav</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">_utt</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">utt_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">_inference&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">_utt</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">utt_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">_forward&quot;</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">add_audio</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">plot_spsvs_params</span><span class="p">(</span>
                    <span class="n">step</span><span class="p">,</span>
                    <span class="n">writer</span><span class="p">,</span>
                    <span class="n">mgc</span><span class="p">,</span>
                    <span class="n">lf0</span><span class="p">,</span>
                    <span class="n">vuv</span><span class="p">,</span>
                    <span class="n">bap</span><span class="p">,</span>
                    <span class="n">pred_mgc</span><span class="p">,</span>
                    <span class="n">pred_lf0</span><span class="p">,</span>
                    <span class="n">pred_vuv</span><span class="p">,</span>
                    <span class="n">pred_bap</span><span class="p">,</span>
                    <span class="n">lf0_score</span><span class="o">=</span><span class="n">lf0_score_denorm_</span><span class="p">,</span>
                    <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
                    <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
                    <span class="n">use_world_codec</span><span class="o">=</span><span class="n">use_world_codec</span><span class="p">,</span>
                    <span class="n">sp</span><span class="o">=</span><span class="n">sp</span><span class="p">,</span>
                    <span class="n">pred_sp</span><span class="o">=</span><span class="n">pred_sp</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># In _quantile_ureduce_func:</span>
                <span class="c1"># IndexError: index -1 is out of bounds for axis 0 with size 0</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">eval_mel_model</span><span class="p">(</span>
    <span class="n">phase</span><span class="p">,</span>
    <span class="n">step</span><span class="p">,</span>
    <span class="n">netG</span><span class="p">,</span>
    <span class="n">in_feats</span><span class="p">,</span>
    <span class="n">out_feats</span><span class="p">,</span>
    <span class="n">lengths</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">,</span>
    <span class="n">out_scaler</span><span class="p">,</span>
    <span class="n">writer</span><span class="p">,</span>
    <span class="n">sr</span><span class="p">,</span>
    <span class="n">lf0_score_denorm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vocoder_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vuv_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">max_num_eval_utts</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># make sure to be in eval mode</span>
    <span class="n">netG</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">prediction_type</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">netG</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">DDP</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">netG</span><span class="o">.</span><span class="n">prediction_type</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">utt_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">max_num_eval_utts</span><span class="p">))</span>
    <span class="n">utt_indices</span> <span class="o">=</span> <span class="n">utt_indices</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">utt_indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_feats</span><span class="p">))]</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">has_dynamic_features</span><span class="p">)</span>
    <span class="n">static_stream_sizes</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">stream_sizes</span>

    <span class="k">for</span> <span class="n">utt_idx</span> <span class="ow">in</span> <span class="n">utt_indices</span><span class="p">:</span>
        <span class="n">out_feats_denorm_</span> <span class="o">=</span> <span class="n">out_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span>
            <span class="n">out_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logmel</span><span class="p">,</span> <span class="n">lf0</span><span class="p">,</span> <span class="n">vuv</span> <span class="o">=</span> <span class="n">get_static_features</span><span class="p">(</span>
            <span class="n">out_feats_denorm_</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">num_windows</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">stream_sizes</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">has_dynamic_features</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logmel</span> <span class="o">=</span> <span class="n">logmel</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">lf0</span> <span class="o">=</span> <span class="n">lf0</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">vuv</span> <span class="o">=</span> <span class="n">vuv</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lf0_score_denorm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lf0_score_denorm_</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">lf0_score_denorm</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lf0_score_denorm_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">group</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">_utt</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">utt_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">_reference&quot;</span>
        <span class="k">if</span> <span class="n">vocoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wav</span> <span class="o">=</span> <span class="n">synthesize_from_mel</span><span class="p">(</span>
                <span class="n">device</span><span class="o">=</span><span class="n">in_feats</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="n">logmel</span><span class="o">=</span><span class="n">logmel</span><span class="p">,</span>
                <span class="n">lf0</span><span class="o">=</span><span class="n">lf0</span><span class="p">,</span>
                <span class="n">vuv</span><span class="o">=</span><span class="n">vuv</span><span class="p">,</span>
                <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
                <span class="n">vuv_threshold</span><span class="o">=</span><span class="n">vuv_threshold</span><span class="p">,</span>
                <span class="n">vocoder</span><span class="o">=</span><span class="n">vocoder</span><span class="p">,</span>
                <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="n">vocoder_in_scaler</span><span class="p">,</span>
                <span class="n">vocoder_config</span><span class="o">=</span><span class="n">vocoder_config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">wav</span> <span class="o">=</span> <span class="n">wav</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">wav</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">add_audio</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span>
        <span class="c1"># Run forward</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="n">netG</span><span class="p">(</span>
            <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
            <span class="n">out_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># ResF0 case</span>
        <span class="k">if</span> <span class="n">netG</span><span class="o">.</span><span class="n">has_residual_lf0_prediction</span><span class="p">():</span>
            <span class="n">outs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">outs</span>

        <span class="c1"># Hybrid</span>
        <span class="k">if</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="n">PredictionType</span><span class="o">.</span><span class="n">MULTISTREAM_HYBRID</span><span class="p">:</span>
            <span class="n">pred_logmel</span><span class="p">,</span> <span class="n">pred_lf0</span><span class="p">,</span> <span class="n">pred_vuv</span> <span class="o">=</span> <span class="n">outs</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">pred_lf0</span> <span class="o">=</span> <span class="n">mdn_get_most_probable_sigma_and_mu</span><span class="p">(</span><span class="o">*</span><span class="n">pred_lf0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pred_lf0</span> <span class="o">=</span> <span class="n">pred_lf0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_logmel</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_logmel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">pred_logmel</span> <span class="o">=</span> <span class="n">mdn_get_most_probable_sigma_and_mu</span><span class="p">(</span><span class="o">*</span><span class="n">pred_logmel</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_logmel</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_logmel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pred_logmel</span> <span class="o">=</span> <span class="n">pred_logmel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">pred_logmel</span><span class="p">,</span> <span class="n">pred_lf0</span><span class="p">,</span> <span class="n">pred_vuv</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="n">PredictionType</span><span class="o">.</span><span class="n">PROBABILISTIC</span><span class="p">:</span>
            <span class="n">pi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">outs</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">mdn_get_most_probable_sigma_and_mu</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">outs</span>
        <span class="c1"># NOTE: multiple outputs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">pred_out_feats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="n">pred_out_feats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">pred_out_feats</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred_out_feats</span><span class="p">]</span>

        <span class="c1"># Run inference</span>
        <span class="k">if</span> <span class="n">prediction_type</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">PredictionType</span><span class="o">.</span><span class="n">PROBABILISTIC</span><span class="p">,</span>
            <span class="n">PredictionType</span><span class="o">.</span><span class="n">MULTISTREAM_HYBRID</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">DDP</span><span class="p">):</span>
                <span class="n">inference_out_feats</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inference_out_feats</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">netG</span><span class="p">,</span> <span class="n">DDP</span><span class="p">):</span>
                <span class="n">inference_out_feats</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inference_out_feats</span> <span class="o">=</span> <span class="n">netG</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
                    <span class="n">in_feats</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">,</span> <span class="p">:</span> <span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">utt_idx</span><span class="p">]],</span>
                <span class="p">)</span>
        <span class="n">pred_out_feats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inference_out_feats</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pred_out_feats_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pred_out_feats</span><span class="p">):</span>
            <span class="n">pred_out_feats_</span> <span class="o">=</span> <span class="n">pred_out_feats_</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">pred_out_feats_denorm</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">out_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">pred_out_feats_</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">in_feats</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">pred_logmel</span><span class="p">,</span> <span class="n">pred_lf0</span><span class="p">,</span> <span class="n">pred_vuv</span> <span class="o">=</span> <span class="n">split_streams</span><span class="p">(</span>
                <span class="n">pred_out_feats_denorm</span><span class="p">,</span> <span class="n">static_stream_sizes</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">_utt</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">utt_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">_inference&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">_utt</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">utt_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">_forward&quot;</span>

            <span class="c1"># Generated sample</span>
            <span class="k">if</span> <span class="n">vocoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">wav</span> <span class="o">=</span> <span class="n">synthesize_from_mel</span><span class="p">(</span>
                    <span class="n">device</span><span class="o">=</span><span class="n">in_feats</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                    <span class="n">logmel</span><span class="o">=</span><span class="n">pred_logmel</span><span class="p">,</span>
                    <span class="n">lf0</span><span class="o">=</span><span class="n">pred_lf0</span><span class="p">,</span>
                    <span class="n">vuv</span><span class="o">=</span><span class="n">pred_vuv</span><span class="p">,</span>
                    <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
                    <span class="n">vuv_threshold</span><span class="o">=</span><span class="n">vuv_threshold</span><span class="p">,</span>
                    <span class="n">vocoder</span><span class="o">=</span><span class="n">vocoder</span><span class="p">,</span>
                    <span class="n">vocoder_in_scaler</span><span class="o">=</span><span class="n">vocoder_in_scaler</span><span class="p">,</span>
                    <span class="n">vocoder_config</span><span class="o">=</span><span class="n">vocoder_config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">wav</span> <span class="o">=</span> <span class="n">wav</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wav</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">wav</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">add_audio</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">plot_mel_params</span><span class="p">(</span>
                    <span class="n">step</span><span class="p">,</span>
                    <span class="n">writer</span><span class="p">,</span>
                    <span class="n">logmel</span><span class="p">,</span>
                    <span class="n">lf0</span><span class="p">,</span>
                    <span class="n">vuv</span><span class="p">,</span>
                    <span class="n">pred_logmel</span><span class="p">,</span>
                    <span class="n">pred_lf0</span><span class="p">,</span>
                    <span class="n">pred_vuv</span><span class="p">,</span>
                    <span class="n">lf0_score</span><span class="o">=</span><span class="n">lf0_score_denorm_</span><span class="p">,</span>
                    <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
                    <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># In _quantile_ureduce_func:</span>
                <span class="c1"># IndexError: index -1 is out of bounds for axis 0 with size 0</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_colorbar_wrap</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%+2.f dB&quot;</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># In _quantile_ureduce_func:</span>
        <span class="c1"># IndexError: index -1 is out of bounds for axis 0 with size 0</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


<div class="viewcode-block" id="plot_spsvs_params">
<a class="viewcode-back" href="../../modules/generated/nnsvs.train_util.plot_spsvs_params.html#nnsvs.train_util.plot_spsvs_params">[docs]</a>
<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">plot_spsvs_params</span><span class="p">(</span>
    <span class="n">step</span><span class="p">,</span>
    <span class="n">writer</span><span class="p">,</span>
    <span class="n">mgc</span><span class="p">,</span>
    <span class="n">lf0</span><span class="p">,</span>
    <span class="n">vuv</span><span class="p">,</span>
    <span class="n">bap</span><span class="p">,</span>
    <span class="n">pred_mgc</span><span class="p">,</span>
    <span class="n">pred_lf0</span><span class="p">,</span>
    <span class="n">pred_vuv</span><span class="p">,</span>
    <span class="n">pred_bap</span><span class="p">,</span>
    <span class="n">lf0_score</span><span class="p">,</span>
    <span class="n">group</span><span class="p">,</span>
    <span class="n">sr</span><span class="p">,</span>
    <span class="n">use_world_codec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">sp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_sp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot acoustic parameters of parametric SVS</span>

<span class="sd">    Args:</span>
<span class="sd">        step (int): step of the current iteration</span>
<span class="sd">        writer (tensorboard.SummaryWriter): tensorboard writer</span>
<span class="sd">        mgc (np.ndarray): mgc</span>
<span class="sd">        lf0 (np.ndarray): lf0</span>
<span class="sd">        vuv (np.ndarray): vuv</span>
<span class="sd">        bap (np.ndarray): bap</span>
<span class="sd">        pred_mgc (np.ndarray): predicted mgc</span>
<span class="sd">        pred_lf0 (np.ndarray): predicted lf0</span>
<span class="sd">        pred_vuv (np.ndarray): predicted vuv</span>
<span class="sd">        pred_bap (np.ndarray): predicted bap</span>
<span class="sd">        f0_score (np.ndarray): lf0 score</span>
<span class="sd">        group (str): group name</span>
<span class="sd">        sr (int): sampling rate</span>
<span class="sd">        use_world_codec (bool): use world codec for spectral envelope or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">assert</span> <span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">fftlen</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">get_cheaptrick_fft_size</span><span class="p">(</span><span class="n">sr</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">pysptk</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">mcepalpha</span><span class="p">(</span><span class="n">sr</span><span class="p">)</span>
    <span class="n">hop_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sr</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">)</span>
    <span class="n">use_mcep_aperiodicity</span> <span class="o">=</span> <span class="n">bap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span>

    <span class="c1"># Log-F0</span>
    <span class="k">if</span> <span class="n">lf0_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">timeaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lf0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.005</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">,</span> <span class="n">lf0</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target log-F0&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">timeaxis</span><span class="p">,</span>
            <span class="n">pred_lf0</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted log-F0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">timeaxis</span><span class="p">,</span>
            <span class="n">lf0_score</span><span class="p">,</span>
            <span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Note log-F0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [sec]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Log-frequency [Hz]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeaxis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">[</span><span class="n">lf0_score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">lf0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lf0</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/ContinuousLogF0&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">f0_score</span> <span class="o">=</span> <span class="n">lf0_score</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">note_indices</span> <span class="o">=</span> <span class="n">f0_score</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">f0_score</span><span class="p">[</span><span class="n">note_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">[</span><span class="n">note_indices</span><span class="p">])</span>

        <span class="c1"># F0</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">timeaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lf0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.005</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)</span>
        <span class="n">f0</span><span class="p">[</span><span class="n">vuv</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pred_f0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)</span>
        <span class="n">pred_f0</span><span class="p">[</span><span class="n">pred_vuv</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">timeaxis</span><span class="p">,</span>
            <span class="n">f0</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target F0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">timeaxis</span><span class="p">,</span>
            <span class="n">pred_f0</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted F0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">,</span> <span class="n">f0_score</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Note F0&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [sec]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency [Hz]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeaxis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">f0_score</span><span class="p">[</span><span class="n">f0_score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)))</span>
            <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">f0_score</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/F0&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># V/UV</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">timeaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lf0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.005</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">,</span> <span class="n">vuv</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target V/UV&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">,</span> <span class="n">pred_vuv</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted V/UV&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [sec]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;V/UV&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeaxis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/VUV&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Spectrogram</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Reference spectrogram&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted spectrogram&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_world_codec</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">decode_spectral_envelope</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mgc</span><span class="p">),</span> <span class="n">sr</span><span class="p">,</span> <span class="n">fftlen</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">pysptk</span><span class="o">.</span><span class="n">mc2sp</span><span class="p">(</span><span class="n">mgc</span><span class="p">,</span> <span class="n">fftlen</span><span class="o">=</span><span class="n">fftlen</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">specshow</span><span class="p">(</span>
        <span class="n">librosa</span><span class="o">.</span><span class="n">power_to_db</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">),</span> <span class="n">ref</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">),</span>
        <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
        <span class="n">x_axis</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="n">y_axis</span><span class="o">=</span><span class="s2">&quot;hz&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_colorbar_wrap</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">use_world_codec</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pred_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pred_spectrogram</span> <span class="o">=</span> <span class="n">pred_sp</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_spectrogram</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">decode_spectral_envelope</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">pred_mgc</span><span class="p">),</span> <span class="n">sr</span><span class="p">,</span> <span class="n">fftlen</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pred_spectrogram</span> <span class="o">=</span> <span class="n">pysptk</span><span class="o">.</span><span class="n">mc2sp</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">pred_mgc</span><span class="p">),</span> <span class="n">fftlen</span><span class="o">=</span><span class="n">fftlen</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">specshow</span><span class="p">(</span>
        <span class="n">librosa</span><span class="o">.</span><span class="n">power_to_db</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred_spectrogram</span><span class="p">),</span> <span class="n">ref</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">),</span>
        <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
        <span class="n">x_axis</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="n">y_axis</span><span class="o">=</span><span class="s2">&quot;hz&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_colorbar_wrap</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sr</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/Spectrogram&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Aperiodicity</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Reference aperiodicity&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted aperiodicity&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_mcep_aperiodicity</span><span class="p">:</span>
        <span class="n">aperiodicity</span> <span class="o">=</span> <span class="n">pysptk</span><span class="o">.</span><span class="n">mc2sp</span><span class="p">(</span><span class="n">bap</span><span class="p">,</span> <span class="n">fftlen</span><span class="o">=</span><span class="n">fftlen</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aperiodicity</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">decode_aperiodicity</span><span class="p">(</span><span class="n">bap</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">sr</span><span class="p">,</span> <span class="n">fftlen</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">specshow</span><span class="p">(</span>
        <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">aperiodicity</span><span class="p">),</span>
        <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
        <span class="n">x_axis</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="n">y_axis</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_colorbar_wrap</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">use_mcep_aperiodicity</span><span class="p">:</span>
        <span class="n">pred_aperiodicity</span> <span class="o">=</span> <span class="n">pysptk</span><span class="o">.</span><span class="n">mc2sp</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">pred_bap</span><span class="p">),</span> <span class="n">fftlen</span><span class="o">=</span><span class="n">fftlen</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pred_aperiodicity</span> <span class="o">=</span> <span class="n">pyworld</span><span class="o">.</span><span class="n">decode_aperiodicity</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">pred_bap</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">sr</span><span class="p">,</span> <span class="n">fftlen</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">specshow</span><span class="p">(</span>
        <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pred_aperiodicity</span><span class="p">),</span>
        <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
        <span class="n">x_axis</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="n">y_axis</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_colorbar_wrap</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sr</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/Aperiodicity&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># GV for mgc</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">mgc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Natural: global variances&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">pred_mgc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Generated: global variances&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Dimension of mgc&quot;</span><span class="p">)</span>
    <span class="n">min_</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">mgc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">pred_mgc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">1e-4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">min_</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/GV_mgc&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># GV for bap</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">bap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Natural: global variances&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">pred_bap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Generated: global variances&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Dimension of bap&quot;</span><span class="p">)</span>
    <span class="n">min_</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">bap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">pred_bap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">min_</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/GV_bap&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">plot_mel_params</span><span class="p">(</span>
    <span class="n">step</span><span class="p">,</span>
    <span class="n">writer</span><span class="p">,</span>
    <span class="n">logmel</span><span class="p">,</span>
    <span class="n">lf0</span><span class="p">,</span>
    <span class="n">vuv</span><span class="p">,</span>
    <span class="n">pred_logmel</span><span class="p">,</span>
    <span class="n">pred_lf0</span><span class="p">,</span>
    <span class="n">pred_vuv</span><span class="p">,</span>
    <span class="n">lf0_score</span><span class="p">,</span>
    <span class="n">group</span><span class="p">,</span>
    <span class="n">sr</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">assert</span> <span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">hop_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sr</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">)</span>

    <span class="c1"># Log-F0</span>
    <span class="k">if</span> <span class="n">lf0_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">timeaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lf0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.005</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">,</span> <span class="n">lf0</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target log-F0&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">timeaxis</span><span class="p">,</span>
            <span class="n">pred_lf0</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted log-F0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">timeaxis</span><span class="p">,</span>
            <span class="n">lf0_score</span><span class="p">,</span>
            <span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Note log-F0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [sec]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Log-frequency [Hz]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeaxis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">[</span><span class="n">lf0_score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">lf0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lf0</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/ContinuousLogF0&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">f0_score</span> <span class="o">=</span> <span class="n">lf0_score</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">note_indices</span> <span class="o">=</span> <span class="n">f0_score</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">f0_score</span><span class="p">[</span><span class="n">note_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0_score</span><span class="p">[</span><span class="n">note_indices</span><span class="p">])</span>

        <span class="c1"># F0</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">timeaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lf0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.005</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)</span>
        <span class="n">f0</span><span class="p">[</span><span class="n">vuv</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pred_f0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)</span>
        <span class="n">pred_f0</span><span class="p">[</span><span class="n">pred_vuv</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">timeaxis</span><span class="p">,</span>
            <span class="n">f0</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target F0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">timeaxis</span><span class="p">,</span>
            <span class="n">pred_f0</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted F0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">,</span> <span class="n">f0_score</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Note F0&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [sec]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency [Hz]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeaxis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">f0_score</span><span class="p">[</span><span class="n">f0_score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)))</span>
            <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">f0_score</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lf0</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred_lf0</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/F0&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># V/UV</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">timeaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lf0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.005</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">,</span> <span class="n">vuv</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Target V/UV&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">,</span> <span class="n">pred_vuv</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted V/UV&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [sec]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;V/UV&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">timeaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">timeaxis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/VUV&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Mel-spectrogram</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Reference spectrogram&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted spectrogram&quot;</span><span class="p">)</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">specshow</span><span class="p">(</span>
        <span class="n">logmel</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
        <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
        <span class="n">x_axis</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="n">y_axis</span><span class="o">=</span><span class="s2">&quot;hz&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_colorbar_wrap</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">specshow</span><span class="p">(</span>
        <span class="n">pred_logmel</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
        <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
        <span class="n">x_axis</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="n">y_axis</span><span class="o">=</span><span class="s2">&quot;hz&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_colorbar_wrap</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sr</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/Spectrogram&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Ryuichi Yamamoto.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>